<%# 
  Recursively render series contents (Items or nested subseries)
  - Items within containers: consolidate all items for that container, and render a checkbox for group
  - Individual items without containers: render individually with checkboxes
  - Subseries: render as collapsible header with recursive call. No checkbox for subseries itself, only for items within it.
%>
<% return unless contents&.any? %>
<% display_groups = Ead::DisplayGroup.build_display_groups(contents) %>
<% display_groups.each_with_index do |group_info, group_index| %>
  <% if group_info[:type] == :item_container %>
    <%# Container group (e.g., Box 9) %>
    <% 
      container_name = group_info[:name]
      group = group_info[:contents]
      # Use container name as subseries if we're directly under the series (no subseries nesting)
      subseries_name = parent_title == series_title ? container_name : parent_title
      checkbox_id = volume_checkbox_id(series_title: series_title, subseries_name: subseries_name)
      content_id = "container-items-#{checkbox_id}"
    %>
    <div class="mt-3 mb-2 d-flex align-items-start gap-2">
      <%# Chevron button to expand/collapse folder list %>
      <%= link_to "##{content_id}", 
            class: 'series-header btn btn-sm btn-link text-decoration-none p-0 ms-2',
            data: { bs_toggle: 'collapse' },
            aria: { expanded: false, controls: content_id } do %>
        <i class="bi bi-chevron-right"></i>
      <% end %>
      <%# Checkbox to select entire container %>
      <%= f.check_box :volumes, 
            { multiple: true, class: 'form-check-input mt-1', id: checkbox_id, 
              data: { action: 'change->archives-request#updateVolumesDisplay' } }, 
            volume_value(series_title: series_title, subseries_name: subseries_name), 
            nil %>
      <div class="flex-grow-1">
        <%= label_tag checkbox_id, container_name, class: 'form-check-label' %>
        <span class="badge bg-light text-dark fw-normal"><%= group.count %></span>
        <%# Collapsible list of items in this container %>
        <div id="<%= content_id %>" class="collapse" data-archives-series-target="content">
          <ul class="list-unstyled ms-2 mt-2">
            <% group.each do |item| %>
              <li class="mb-1">
                <% if item.folder %>
                  <small class="text-muted">Folder <%= item.folder %>:</small>
                <% end %>
                <%= item.title %>
              </li>
            <% end %>
          </ul>
        </div>
      </div>
    </div>
  <% elsif group_info[:type] == :individual_item %>
    <%# Individual item without container - gets its own checkbox %>
    <% 
      item = group_info[:item]
      checkbox_id = volume_checkbox_id(series_title: series_title, subseries_name: item.title)
    %>
    <div class="mt-3 mb-2">
      <%= f.check_box :volumes, 
            { multiple: true, class: 'form-check-input me-2', id: checkbox_id, 
              data: { action: 'change->archives-request#updateVolumesDisplay' } }, 
              volume_value(series_title: series_title, subseries_name: item.title),
            nil %>
      <%= label_tag checkbox_id, item.title, class: 'form-check-label' %>
    </div>
  <% elsif group_info[:type] == :subseries %>
    <%# Subseries (intellectual/non-physical hierarchical grouping) %>
    <% 
      subseries = group_info[:data]
      subseries_id = collapsible_content_id(
        prefix: 'subseries',
        series_title: parent_title,
        item_name: subseries[:title],
        index: group_index
      )
    %>
    <div class="mt-3 mb-2 ms-2">
      <%# Subseries header (collapsible) %>
      <%= link_to "##{subseries_id}", 
            class: 'series-header btn btn-link text-decoration-none text-start p-0 mb-2 d-flex align-items-center gap-2',
            data: { bs_toggle: 'collapse' },
            aria: { expanded: false, controls: subseries_id } do %>
        <i class="bi bi-chevron-right"></i>
        <span><%= subseries[:title] %></span>
        <span class="badge bg-light text-dark fw-normal"><%= subseries[:contents].count %></span>
      <% end %>
      <%# Subseries content (recursive) %>
      <div id="<%= subseries_id %>" class="collapse ms-3" data-archives-series-target="content">
        <%= render partial: 'series_contents', locals: { contents: subseries[:contents], f: f, parent_title: subseries[:title], series_title: series_title } %>
      </div>
    </div>
  <% end %>
<% end %>
