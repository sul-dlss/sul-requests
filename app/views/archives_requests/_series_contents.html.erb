<%# 
  Recursively render series contents
  - ItemContainer: consolidate all items for that container, and render a checkbox for group
  - ItemWithoutContainer: render individually with checkboxes
  - Subseries: render as collapsible header with recursive call. No checkbox for subseries itself, only for items within it.
%>
<% contents.each_with_index do |display_group, group_index| %>
  <% if display_group.is_a?(Ead::DisplayGroup::ItemContainer) %>
    <%# Container group (e.g., Box 9) %>
    <% 
      container_name = display_group.name
      group = display_group.contents
      checkbox_id = volume_checkbox_id(series_title: series_title || container_name, subseries_name: container_name)
      content_id = "container-items-#{checkbox_id}"
    %>
    <div class="mb-2 d-flex align-items-start gap-2">
      <%# Chevron button to expand/collapse folder list %>
      <%= link_to "##{content_id}", 
            class: 'series-header btn btn-sm btn-link text-decoration-none p-0 ms-2',
            data: { bs_toggle: 'collapse' },
            aria: { expanded: false, controls: content_id } do %>
        <i class="bi bi-chevron-right disclosure-icon"></i>
      <% end %>
      <%# Checkbox to select entire container %>
      <%= f.check_box :volumes, 
            { multiple: true, class: 'form-check-input mt-1', id: checkbox_id, checked: f.object.items.any? { |item| series_title == item[:series] && container_name == item[:subseries] } ,
              data: { action: 'change->archives-request#itemChanged change->archives-request#updateVolumesDisplay', 'archives-request-target': 'items', 'archives-request-series-param': series_title, 'archives-request-subseries-param': container_name, 'archives-request-id-param': checkbox_id } },
            checkbox_id,
            nil %>
      <div class="flex-grow-1">
        <%= label_tag checkbox_id, container_name, class: 'form-check-label' %>
        <span class="badge bg-dark-subtle text-dark fw-normal rounded-pill"><%= group.count %></span>
        <%# Collapsible list of items in this container %>
        <div id="<%= content_id %>" class="collapse" data-archives-series-target="content">
          <ul class="list-unstyled ms-2 my-2">
            <% group.each do |item| %>
              <li class="mb-1">
                <% if item.folder %>
                  <small class="text-muted">Folder <%= item.folder %>:</small>
                <% end %>
                <%= item.title %>
              </li>
            <% end %>
          </ul>
        </div>
      </div>
    </div>
  <% elsif display_group.is_a?(Ead::DisplayGroup::ItemWithoutContainer) %>
    <%# Individual item without container - gets its own checkbox %>
    <% 
      checkbox_id = volume_checkbox_id(series_title: series_title || container_name, subseries_name: display_group.title)
    %>
    <div class="mb-2">
      <%= f.check_box :volumes, 
            { multiple: true, class: 'form-check-input me-2', id: checkbox_id, 
              data: { action: 'change->archives-request#updateVolumesDisplay' } }, 
              volume_value(series_title: series_title || container_name, subseries_name: display_group.title),
            nil %>
      <%= label_tag checkbox_id, display_group.title, class: 'form-check-label' %>
    </div>
  <% elsif display_group.is_a?(Ead::DisplayGroup::Subseries) %>
    <%# Subseries (intellectual/non-physical hierarchical grouping) %>
    <% 
      subseries_id = collapsible_content_id(
        prefix: 'subseries',
        series_title: parent_title || display_group.title,
        item_name: display_group.title,
        index: group_index
      )
    %>
    <div class="my-1">
      <%# Subseries header (collapsible) %>
      <%= link_to "##{subseries_id}", 
            class: 'series-header btn btn-link text-decoration-none text-start p-0 mb-2 d-flex align-items-center gap-2',
            data: { bs_toggle: 'collapse' },
            aria: { expanded: false, controls: subseries_id } do %>
        <i class="bi bi-chevron-right disclosure-icon"></i>
        <span class="<%= 'series-title' if series_title.nil? %>"><%= display_group.title %></span>
        <span class="badge bg-dark-subtle text-dark fw-normal rounded-pill"><%= display_group.contents.count %></span>
      <% end %>
      <%# Subseries content (recursive) %>
      <div id="<%= subseries_id %>" class="collapse mt-2 ms-3" data-archives-series-target="content">
        <%= render partial: 'series_contents', locals: { contents: display_group.contents, f: f, parent_title: display_group.title, series_title: series_title || display_group.title } %>
      </div>
    </div>
  <% end %>
<% end %>
