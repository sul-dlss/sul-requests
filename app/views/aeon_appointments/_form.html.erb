<%= form_with(model: @appointment, data: { controller: 'appointment' }) do |f| %>
  <div class="mb-3">
    <%= f.label :name, class: 'd-block fw-semibold' %>
    <%= f.text_field :name %>
  </div>

  <div class="mb-3">
    <% if @appointment.reading_room_id %>
      <div class="fw-semibold">Reading room:</div>
      <div><%= @appointment.reading_room.name %><%= f.hidden_field :reading_room_id %></div>
    <% else %>
      <%= f.label :reading_room_id, 'Reading room', class: 'd-block fw-semibold' %>
      <%= f.select :reading_room_id, @reading_rooms.map { |rr| [rr.name, rr.id] }, data: { action: 'appointment#refreshAvailability' } %>
    <% end %>
  </div>


  <div class="mb-3">
    <%= f.label :date, class: 'd-block fw-semibold' %>
    <%= f.date_field :date, required: true, data: { action: 'appointment#refreshAvailability' } %>
  </div>

  <% if @appointment.start_time && @appointment.stop_time && (!@appointment.start_time.min.in?([0,15,30,45]) || !(@appointment.stop_time - @appointment.start_time).in?([30.minutes, 1.hour, 1.5.hours, 2.hours, 3.hours, 4.hours])) %>
    <div class="mb-3">
      <%= f.label :start_time, class: 'd-block fw-semibold' %>
      <%= f.time_field :start_time, required: true %>
    </div>
    <div class="mb-3">
      <%= f.label :stop_time, class: 'd-block fw-semibold' %>
      <%= f.time_field :stop_time, required: true %>
    </div>
  <% else %>
    <fieldset class="mb-3">
      <legend class="fs-6 fw-semibold">Duration</legend>

      <% [30.minutes, 1.hour, 1.5.hours, 2.hours, 3.hours, 4.hours].each do |duration| %>
        <%= f.radio_button :duration, duration.to_i, class: 'btn-check', checked: (@appointment.start_time && @appointment.stop_time ? (@appointment.stop_time - @appointment.start_time) : 30.minutes) == duration, data: { action: 'appointment#applyDurationFilter' } %>
        <%= f.label "duration_#{duration.to_i}", duration.inspect, class: 'btn' %>
      <% end %>
    </fieldset>

    <turbo-frame id="available_appointments" data-action="turbo:frame-load->appointment#applyDurationFilter" data-appointment-target="availability" src="<%= available_aeon_appointments_url(@appointment.reading_room_id, @appointment.date || Time.zone.now.iso8601, selected: @appointment.start_time.strftime('%-I:%M %p')) if @appointment.reading_room_id %>">
      <fieldset class="mb-3">
        <legend class="fs-6 fw-semibold">Available time slots</legend>
        <% if @appointment.reading_room_id && @appointment.date %>
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        <% else %>
          <div class="alert alert-info">Select a date and reading room to see available appointments.</div>
        <% end %>
      </fieldset>
    </turbo-frame>
  <% end %>

  <%= link_to 'Cancel', aeon_appointments_path, class: 'btn btn-outline-primary' %>
  <%= f.submit class: 'btn btn-primary' %>
<% end %>
