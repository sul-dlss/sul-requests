<% if current_user&.patron %>
  <%= render 'user_header' %>
<% end %>

<h1 class="fw-light mt-5 text-cardinal"><%= current_request.item_title %></h1>
<% if current_request.items_in_location.one? %>
  <div class="my-3 h2">Call number: <%= current_request.items_in_location.first&.callnumber %></div>
<% end %>

<%= form_for(@request, data: { controller: 'patronRequest' }) do |f| %>
  <%= f.hidden_field :instance_hrid %>
  <%= f.hidden_field :origin_location_code %>

  <div id="earliestAvailableContainer" class="text-cardinal my-4" aria-live="polite">
    Earliest available:
    <%= turbo_frame_tag('earliestAvailable', src: paging_schedule_url(origin: @request.origin_location_code, destination: f.object.service_point_code || f.object.default_service_point_code), data: { 'patronRequest-target' => 'earliestAvailable'}) do %>
      Loading..
    <% end %>
  </div>

  <% if f.object.pickup_destinations.many? %>
    <div class="form-group row mb-3 me-0">
      <%= f.label :service_point_code, class: 'required-label col-2' %>
      <%=  f.select(
      :service_point_code, pickup_destinations_array(f.object.pickup_destinations),
      {
        label: label_for_pickup_destinations_dropdown(f.object.pickup_destinations),
        selected: f.object.service_point_code || f.object.default_service_point_code,
        include_blank: false, required: false,
      },
      data: {
        action: 'change->patronRequest#updateEarliestAvailable',
      },
      aria: {
        controls: 'earliestAvailableContainer',
      },
      class: 'form-select col'
    ) %>
    </div>
  <% end %>

  <div class="form-group d-flex justify-content-end gap-1">
    <%= link_to 'Cancel', new_patron_request_path(instance_hrid: @request.instance_hrid, origin_location_code: @request.origin_location_code), class: 'btn btn-outline-primary' %>
    <%= f.submit t('.submit'), class: 'btn btn-primary' %>
  </div>
<% end %>
